<!DOCTYPE html>
<html>
<head>
    <title>Discussions</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",launch:function(){this._filters=[{property:"LastUpdateDate",operator:">=",value:Ext.Date.subtract(new Date,Ext.Date.MINUTE,20160)}],Ext.create("Rally.data.wsapi.artifact.Store",{models:["UserStory","Defect","Task"],context:this.getContext().getDataContext(),autoLoad:!0,remoteSort:!1,fetch:["FormattedID","TargetDate","Discussion","LatestDiscussionAgeInMinutes","LastUpdateDate","Name","State","ScheduleState","Owner","PlanEstimate"],filters:this._filters,listeners:{load:this._onArtifactsLoaded,scope:this}})},_onArtifactsLoaded:function(t,e){t.sort({property:"LatestDiscussionAgeInMinutes",direction:"ASC"}),this._createGrid(t.getRecords())},_createGrid:function(t){_.each(t,function(t){t.raw.lastPost="",t.raw.posts=Ext.create("Rally.data.wsapi.Store",{model:"ConversationPost",data:[]})}),_store=Ext.create("Rally.data.custom.Store",{data:t,groupField:"FormattedID",pageSize:100}),this.grid||(this.grid=this.add({margin:20,xtype:"rallygrid",itemId:"mygrid",store:_store,collapsible:!0,columnCfgs:[{text:"Artifact",dataIndex:"FormattedID"},{text:"Title",dataIndex:"Name",flex:1},{text:"Last Artefact Update",dataIndex:"LastUpdateDate",xtype:"datecolumn",format:"F j, Y, g:i a"},{text:"Schedule State",dataIndex:"ScheduleState"},{text:"Plan Estimate",dataIndex:"PlanEstimate"},{text:"Last Post",flex:2,dataIndex:"lastPost",renderer:function(t,e,a,s,o,r,n){return 0===a.raw.posts.getRecords().length&&a.get("Discussion").Count>0?(a.getCollection("Discussion").load({fetch:["Text","CreationDate"],sorters:[{property:"CreationDate",direction:"DESC"}],callback:function(t,e,s){s?(_.each(t,function(t){console.log("adding: ",t," to: ",a.raw.posts),a.raw.posts.add(t)}),a.set("lastPost",t[0].get("Text"))):a.set("lastPost","")}}),"Fetching.."):a.get("lastPost")}},{text:"Last Discussion Date",dataIndex:"LatestDiscussionAgeInMinutes",renderer:function(t){return t?Ext.Date.format(Ext.Date.subtract(new Date,Ext.Date.MINUTE,t),"F j, Y, g:i a").toString():null}}]}))}});

            Rally.launchApp('CustomApp', {
                name:"Discussions",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
